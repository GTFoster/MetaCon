library(mgcv)
library(spatialEco)
library(dplyr)
library(rgbif)
library(rnaturalearth)
library(rJava)
sf_use_s2(FALSE) #Don't assume a sphericical geometry-therefore dist for buffer will be in units of degree
crul::set_opts(http_version = 2) #For getting gbif queries to work: https://github.com/ropensci/crul/issues/174#issuecomment-1600273273
Moulatlet <- read.csv(file="../Data/datalong_v08_06_2023_CLEANED.csv")
Moulatletval <- Moulatlet %>% dplyr::select(., Scientific, plant_id, interaction, lat, lon) %>% dplyr::filter(interaction %in% (c(0,1))) %>% dplyr::select(., Scientific, plant_id, interaction, lat, lon) %>% dplyr::rename(., Latitude=lat, Longitude=lon, Frugivore_Species=Scientific, Plant_Species=plant_id) %>%
unique()
Moulatletval$interaction <- as.numeric(Moulatletval$interaction)
counts <- Moulatletval %>% dplyr::mutate(., speciesPair=paste(Frugivore_Species, Plant_Species, sep="-")) %>%
group_by(., speciesPair) %>%
dplyr::summarise(., pos=sum(interaction), tot=n(), neg=tot-pos)
counts <- Moulatletval %>% dplyr::mutate(., speciesPair=paste(Frugivore_Species, Plant_Species, sep="-")) %>% dplyr::select(., speciesPair ) %>% left_join(counts, .) %>% unique()
counts$prop <- counts$pos/counts$tot
#pdf(file="Figures/MoulatletInterSummary.pdf")
counts %>% dplyr::filter(., tot>9) %>%
ggplot(., aes(x=tot, y=prop))+geom_point(position = "jitter")+theme_classic()+ylab("Proportion of Interactions given Coocurence")+xlab("Number of Coocurrences")+ annotate("text", x = 31, y = .25, label = "211 interactions total")+ annotate("text", x = 31, y = .2, label = "44 birds, 37 plants")
#dev.off()
usable <- counts %>% dplyr::filter(., tot>4) %>% unique()#Number of interactions with at least 10 records
table(usable$ID)
Moulatletval <- Moulatletval %>% dplyr::mutate(., speciesPair=paste(Frugivore_Species, Plant_Species, sep="-"))
usable <- left_join(usable, Moulatletval, by="speciesPair") %>% unique()
length(unique(usable$Frugivore_Species))
length(unique(usable$Plant_Species))
library(rnaturalearth)
library(rnaturalearthdata)
world <- ne_countries(scale = "medium", returnclass = "sf")
usable$Latitude <- as.numeric(usable$Latitude)
usable$Longitude <- as.numeric(usable$Longitude)
#pdf(file="Figures/MoulatletMap_10occ.pdf", width=11, height=8.5)
ggplot(data = world) +
geom_sf()+theme_classic()+geom_point(data=usable, aes(x=Longitude, y=Latitude))
#dev.off()
gbifQuery <- function(name, doplot=FALSE){
record <- rgbif::occ_search(scientificName = name, hasGeospatialIssue=FALSE)
keynum <- rgbif::name_backbone(name)$usageKey
gbif_download <- occ_download(pred("taxonKey", keynum),format = "SIMPLE_CSV", user="riverman12", pwd="1Chicken!!!", email="fostergt@email.sc.edu")
occ_download_wait(gbif_download)
spdat <- occ_download_get(gbif_download) %>%
occ_download_import() # download data
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
#ggplot(data = world) +
#geom_sf()+geom_point(data=spdat, aes(x=decimalLongitude, y=decimalLatitude))+theme_classic()
if(doplot==TRUE){
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) +
geom_sf()+geom_point(data=p1, aes(x=decimalLongitude, y=decimalLatitude))+theme_classic()
}
spatsmall <- dplyr::select(spdat, species, decimalLongitude, decimalLatitude)
spatsmall <- as.data.frame(spatsmall)
return(spatsmall)
}
spnames <- unique(c(usable$Plant_Species, usable$Frugivore_Species))
comp_occs <- NULL
iters <- 35
for(i in 1:iters){
filnam <- spnames[i] %>% tolower() %>% gsub(pattern=" ", replacement="_") %>% paste("data/GBIF/occs/", .,".csv", sep="")
temp <- read.csv(file=filnam)
if(nrow(temp)==0){
next
}
occ <- temp %>% dplyr::select(., decimalLongitude, decimalLatitude, species) %>% dplyr::filter(., is.na(decimalLongitude)==FALSE) %>% unique()
occ['cells'] <-terra::cellFromXY(object= Clima[[1]], xy = occ[,1:2]) #Grab the occurance cells & remove redundant records
sf_use_s2(FALSE) #Don't assume a spherical geometry-therefore dist for buffer will be in units of degree
#creating a 200km2 buffer to select the psudo-absence points
OccSf <-sf::st_as_sf(x=occ[,1:2], coords = c("decimalLongitude",'decimalLatitude'),
crs=sp::CRS("EPSG:4326")) #crs=sp::CRS("+proj=longlat +ellps=WGS84
OccBuffer <-sf::st_buffer(OccSf, dist=2) #Create buffer objects
OccBuffer <-sf::st_union(OccBuffer) #Merge buffer objects into one
#plot(OccBuffer)
##Masking the buffer so that it does not occur in the ocean
OccBuffer2 <-as(OccBuffer, 'Spatial')
#terra::plot(OccBuffer2)
OccBuffer2 <- terra::vect(OccBuffer)
OccBufferRas <-terra::rasterize(x = OccBuffer2, y=Clima)
OccBufferRas<-raster::mask(x = OccBufferRas, mask = Clima[[1]])
#plot(OccBufferRas)
##Selecting the pseudo absences. Since I'm doing 1:1 Presence:Psuedoabsence, I'm saving the cell number in the df as a seperate column.
AllPseudo <- terra::as.points(OccBufferRas)
AllPseudo <- raster::extract(x= Clima[[1]], AllPseudo,cell=T)
AllPseudo<-AllPseudo[-(which(AllPseudo$cell %in% occ$cells)),]
occ$psuedocell <- sample(AllPseudo$cell, size=nrow(occ), replace=F)
comp_occs <- rbind(comp_occs, occ) #rbind lates species to composite df
if(i%%10==0){ #if it's an interval of 10 save just in case
write.csv(comp_occs, file="data/comp_occurances.csv", row.names = F)
}
if(i==iters){ #if it's the full number of spp, then do save the final file.
write.csv(comp_occs, file="data/comp_occurances.csv", row.names = F)
}
print(i)
}
#Getting climate data
Clima <- geodata::worldclim_global("worldclim", var="bio", res=2.5)
terra::plot(Clima[[1]])
#Here's loading all of these in and merging them
#tile53 <- raster::stack("worldclim/wc2.1_tiles/tile_53_wc2.1_30s_bio.tif")
#tile52 <- raster::stack("worldclim/wc2.1_tiles/tile_52_wc2.1_30s_bio.tif")
#tile29 <- raster::stack("worldclim/wc2.1_tiles/tile_29_wc2.1_30s_bio.tif")
#tile28 <- raster::stack("worldclim/wc2.1_tiles/tile_28_wc2.1_30s_bio.tif")
#tile41 <- raster::stack("worldclim/wc2.1_tiles/tile_41_wc2.1_30s_bio.tif")
#tile40 <- raster::stack("worldclim/wc2.1_tiles/tile_40_wc2.1_30s_bio.tif")
#SA <- terra::merge(tile53, tile52, tile29, tile28, tile41, tile40)
#plot(SA)
Climastack <- raster::stack(Clima)
comp_occs <- read.csv(file="data/comp_occurances.csv")
comp_occs$PA <- 1 #Add a 1 to the presence absence file-my b, changed my mind how I wanted things organized
abs <- dplyr::select(comp_occs, -cells) %>% dplyr::mutate(., decimalLongitude=NA, decimalLatitude=NA, PA=0) %>% dplyr::rename(., cells=psuedocell)
pres <- dplyr::select(comp_occs, -psuedocell)
comp_long <- rbind(abs, pres)
rm(abs, pres)
#c(comp_occs$cells, comp_occs$cells)
ext <- terra::extract(Climastack, comp_long$cells)
comp_long$na_pres <- is.na(ext[,1]) #Add
#Running a PCA over our climatic data
#EnvCoord<-na.omit(raster::rasterToPoints(Climastack)) #Make raster into long df of points
#PcaR<-EnvCoord[,-c(1:2)] #remove latlong for PCA
#Scale transform
DScale <- data.frame(apply(na.omit(ext),2,scale)) %>% na.omit()#scale
#Run the  PCA
DPca <- prcomp(DScale,retx=TRUE,center=F,scale=F) #run PCA on scaled data
#% of the variation explained
NEixos<-length(summary(DPca)$importance[3,])
CumVar<-summary(DPca)$importance[3,]
VarEx<-data.frame(CumVar)
#Getting the loadings and transforming it into a dataframe
Eix<-as.data.frame(DPca$x) #Grab the PCA loadings
val <- comp_occs %>% dplyr::filter(., na_pres==FALSE) %>% cbind(., Eix)
val <- comp_long %>% dplyr::filter(., na_pres==FALSE) %>% cbind(., Eix)
View(val)
EixXY <- comp_long %>% dplyr::filter(., na_pres==FALSE) %>% cbind(., Eix)
#EixXY<-cbind(ext[,(1:2)],Eix) #re add back in the coordinates from earlier
sp::gridded(EixXY)<- ~x+y #Create large spatial pixels df (prep to reconvert to raster)
View(EixXY)
PCAPr<-raster::stack(EixXY) #create a rasterstack for each
OccSf
plot(raster.comb)
?prepareData()
training<-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
raster.comb
terra::xyFromCell(EixXY$cells)
terra::xyFromCell(EixXY$cells,Clima)
terra::xyFromCell(Clima,EixXY$cells)
XY <- terra::xyFromCell(Clima,EixXY$cells)
View(XY)
terra::xyFromCell(Clima,EixXY$cells) %>% cbind(., EixXY)
EixXY <- terra::xyFromCell(Clima,EixXY$cells) %>% cbind(., EixXY)
View(EixXY)
#EixXY<-cbind(ext[,(1:2)],Eix) #re add back in the coordinates from earlier
sp::gridded(EixXY)<- ~x+y #Create large spatial pixels df (prep to reconvert to raster)
PCAPr<-raster::stack(EixXY) #create a rasterstack for each
EixXY
EixXY <- comp_long %>% dplyr::filter(., na_pres==FALSE) %>% cbind(., Eix)
spdat <- EixXy
spob <- EixXY
spob
EixXY <- terra::xyFromCell(Clima,EixXY$cells) %>% cbind(., EixXY)
spob <- EixXY
spob
spob <- EixXY %>% dplyr::select(., -decimalLongitude, -decimalLatitude, -species)
spob
spob <- EixXY %>% dplyr::select(., -decimalLongitude, -decimalLatitude, -species, -cells, -PA, -na_pres)
spob
spob <- EixXY %>% dplyr::select(., -decimalLongitude, -decimalLatitude, -species, -cells, -PA, -na_pres) %>% unique()
#EixXY<-cbind(ext[,(1:2)],Eix) #re add back in the coordinates from earlier
sp::gridded(spob)<- ~x+y #Create large spatial pixels df (prep to reconvert to raster)
plot(spob)
PCAPr<-raster::stack(EixXY) #create a rasterstack for each
raster.comb<-PCAPr[[1:(sum(VarEx<=0.95)+1)]] #only include the axis necessary to explain 95% of variation
View(PCAPr)
PCAPr<-raster::stack(spob) #create a rasterstack for each
raster.comb<-PCAPr[[1:(sum(VarEx<=0.95)+1)]] #only include the axis necessary to explain 95% of variation
plot(raster.comb)
Occ
sp
sp
spnames
comp_long
head(comp_long)
i <-1
Occ <- dplyr::filter(comp_long, species==spnames[i])
View(Occ)
Occ
PseudoA
comp_occs
Occ <- dplyr::filter(comp_occs, species==spnames[i])
View(Occ)
?dismo::prepareData
?dismo::maxent
comp_occs
terra::xyFromCell(raster.comb, Occ$cells)
spots <- terra::xyFromCell(raster.comb, Occ$cells) %>% dplyr::rename(., x="Long", y="Lat")
terra::xyFromCell(raster.comb, Occ$cells)
spots <- terra::xyFromCell(raster.comb, Occ$cells) %>% as.dataframe() %>% dplyr::rename(., x="Long", y="Lat")
spots <- terra::xyFromCell(raster.comb, Occ$cells) %>% dataframe() %>% dplyr::rename(., x="Long", y="Lat")
spots <- terra::xyFromCell(raster.comb, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., x="Long", y="Lat")
spots <- terra::xyFromCell(raster.comb, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., "Long"=x, "Lat"=y)
View(spots)
Aspots <- terra::xyFromCell(raster.comb, Occ$psuedocell) %>% as.data.frame()
View(Aspots)
Occurrences <- cbind(Pspots, Aspots)
Pspots <- terra::xyFromCell(raster.comb, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., "Long"=x, "Lat"=y)
Aspots <- terra::xyFromCell(raster.comb, Occ$psuedocell) %>% as.data.frame()
Occurrences <- cbind(Pspots, Aspots)
colnames(Occurrences)
id.training<-sample(1:nrow(Occurrences),round(0.75*nrow(Occurrences),0))
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
testing<-prepareData(x=raster.comb, p=Occurrences[-id.training,c("Long", "Lat")], b=Occurrences[-id.training,c("x", "y")])
training<-na.omit(training)
testing<-na.omit(testing)
Occurrences2<-Occurrences
colnames(Occurrences2)<-rep(c('Long','Lat'),2)
testingPresPA<-rbind.data.frame(Occurrences2[-id.training,1:2],Occurrences2[-id.training,3:4])
##Maxent
Sys.setenv(NOAWT=TRUE)
Maxent.Model<-dismo::maxent(x = as.data.frame(training[,-1]), p = as.data.frame(training[,1])) #Train Maxent Model
training
dismo
training
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
training
training
Occurrences <- cbind(Pspots, Aspots)
id.training<-sample(1:nrow(Occurrences),round(0.75*nrow(Occurrences),0))
id.training
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
training
training
?dismo::prepareData()
Occurrences[id.training,c("Long", "Lat")]
Occurrences[id.training,c("Long", "Lat")]
plot(raster.comb[[1]])
point(x=Occurrences$Long, y=Occurrences$Lat)
plot(raster.comb[[1]])
points(x=Occurrences$Long, y=Occurrences$Lat)
View(Occurrences)
i
spnames[1]
Pspots <- terra::xyFromCell(Clima, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., "Long"=x, "Lat"=y)
Aspots <- terra::xyFromCell(Clima, Occ$psuedocell) %>% as.data.frame()
Occurrences <- cbind(Pspots, Aspots)
id.training<-sample(1:nrow(Occurrences),round(0.75*nrow(Occurrences),0))
plot(raster.comb[[1]])
points(x=Occurrences$Long, y=Occurrences$Lat)
plot(raster.comb[[1]])
points(x=Occurrences$Long, y=Occurrences$Lat)
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
testing<-prepareData(x=raster.comb, p=Occurrences[-id.training,c("Long", "Lat")], b=Occurrences[-id.training,c("x", "y")])
training
training<-na.omit(training)
testing<-na.omit(testing)
Occurrences2<-Occurrences
colnames(Occurrences2)<-rep(c('Long','Lat'),2)
testingPresPA<-rbind.data.frame(Occurrences2[-id.training,1:2],Occurrences2[-id.training,3:4])
##Maxent
Sys.setenv(NOAWT=TRUE)
Maxent.Model<-dismo::maxent(x = as.data.frame(training[,-1]), p = as.data.frame(training[,1])) #Train Maxent Model
Maxent.eval<-evaluate(p = testing[testing[,"pb"]==1,-1], a = testing[testing[,"pb"]==0,-1], model = Maxent.Model)
Maxent.eval
save(Maxent.Model, Maxent.eval, file=paste("MaxentModels/Maxent_test_", gsub(pattern=" ", spnames[i], replacement="_"), ".Rda", sep=""))
plot(Maxent.Model)
Maxent.Model
for(i in 1:length(spnames)){
Occ <- dplyr::filter(comp_occs, species==spnames[i]) #Filter to target species
Pspots <- terra::xyFromCell(Clima, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., "Long"=x, "Lat"=y) #Extract presence xy
Aspots <- terra::xyFromCell(Clima, Occ$psuedocell) %>% as.data.frame() #extract absence xy
Occurrences <- cbind(Pspots, Aspots)
id.training<-sample(1:nrow(Occurrences),round(0.75*nrow(Occurrences),0))
#plot(raster.comb[[1]])
#points(x=Occurrences$Long, y=Occurrences$Lat)
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
testing<-prepareData(x=raster.comb, p=Occurrences[-id.training,c("Long", "Lat")], b=Occurrences[-id.training,c("x", "y")])
training<-na.omit(training)
testing<-na.omit(testing)
Occurrences2<-Occurrences
colnames(Occurrences2)<-rep(c('Long','Lat'),2)
testingPresPA<-rbind.data.frame(Occurrences2[-id.training,1:2],Occurrences2[-id.training,3:4])
##Maxent
Sys.setenv(NOAWT=TRUE)
Maxent.Model<-dismo::maxent(x = as.data.frame(training[,-1]), p = as.data.frame(training[,1])) #Train Maxent Model
#Maxent.0  <-dismo::predict(object = Maxent.Model, x = raster.comb, args='outputformat=cloglog')
Maxent.eval<-evaluate(p = testing[testing[,"pb"]==1,-1], a = testing[testing[,"pb"]==0,-1], model = Maxent.Model)
save(Maxent.Model, Maxent.eval, file=paste("MaxentModels/Maxent_test_", gsub(pattern=" ", spnames[i], replacement="_"), ".Rda", sep=""))
rm(Maxent.Model, Maxent.eval)
}
for(i in 1:length(spnames)){
Occ <- dplyr::filter(comp_occs, species==spnames[i]) #Filter to target species
if(nrow(Occ)==0){
next #Skip if there are no records
}
Pspots <- terra::xyFromCell(Clima, Occ$cells) %>% as.data.frame() %>% dplyr::rename(., "Long"=x, "Lat"=y) #Extract presence xy
Aspots <- terra::xyFromCell(Clima, Occ$psuedocell) %>% as.data.frame() #extract absence xy
Occurrences <- cbind(Pspots, Aspots)
id.training<-sample(1:nrow(Occurrences),round(0.75*nrow(Occurrences),0))
#plot(raster.comb[[1]])
#points(x=Occurrences$Long, y=Occurrences$Lat)
training <-dismo::prepareData(x=raster.comb, p=Occurrences[id.training,c("Long", "Lat")], b=Occurrences[id.training,c("x", "y")])
testing<-prepareData(x=raster.comb, p=Occurrences[-id.training,c("Long", "Lat")], b=Occurrences[-id.training,c("x", "y")])
training<-na.omit(training)
testing<-na.omit(testing)
Occurrences2<-Occurrences
colnames(Occurrences2)<-rep(c('Long','Lat'),2)
testingPresPA<-rbind.data.frame(Occurrences2[-id.training,1:2],Occurrences2[-id.training,3:4])
##Maxent
Sys.setenv(NOAWT=TRUE)
Maxent.Model<-dismo::maxent(x = as.data.frame(training[,-1]), p = as.data.frame(training[,1])) #Train Maxent Model
#Maxent.0  <-dismo::predict(object = Maxent.Model, x = raster.comb, args='outputformat=cloglog')
Maxent.eval<-evaluate(p = testing[testing[,"pb"]==1,-1], a = testing[testing[,"pb"]==0,-1], model = Maxent.Model)
save(Maxent.Model, Maxent.eval, file=paste("MaxentModels/Maxent_test_", gsub(pattern=" ", spnames[i], replacement="_"), ".Rda", sep=""))
rm(Maxent.Model, Maxent.eval)
}
i
spnames[31]
spnames[20]
spnames[30]
spnames[31]
i <- 31
2+2
i <- 31
Occ <- dplyr::filter(comp_occs, species==spnames[i]) #Filter to target species
i <- 30
Occ <- dplyr::filter(comp_occs, species==spnames[i]) #Filter to target species
i <- 29
Occ <- dplyr::filter(comp_occs, species==spnames[i]) #Filter to target species
setwd("~/Documents/MetaCon/Analysis")
knitr::opts_chunk$set(echo = TRUE)
dat <- read.csv("Data.nosync/DataSources/ATLANTIC_frugivory.csv")
dat %<>% dplyr::filter(., Frugivore_Species != "Carollia castanea") #This bat has an incorrect gape size, so it's filtered out
library(tidyverse)
library(magrittr)
library(igraph)
library(pROC)
library(BIEN)
library(np)
library(PVR)
library(ape)
library("phytools")
#library(tictoc)
library(corrplot)
dat <- read.csv("Data.nosync/DataSources/ATLANTIC_frugivory.csv")
dat %<>% dplyr::filter(., Frugivore_Species != "Carollia castanea") #This bat has an incorrect gape size, so it's filtered out
dat <- dplyr::select(dat, -ID, -Latitude, -Longitude, -Study_Location, -Precision, -Study_Method, -Study.reference, -Doi.Link, -Frug_Population_Trend, -Frug_Migration_status)
dat %<>% unique(.)
load("Data.nosync/DataSources/BIEN_subtree.Rda")
Mammal_trees <- ape::read.nexus(file="Data.nosync/DataSources/VertLife_FrugMam/output.nex")
Bird_trees <- ape::read.nexus(file="Data.nosync/DataSources/VertLife_FrugBird/output.nex")
#dat <- dplyr::filter_at(dat, vars(Plant_Form, Frugivory_score, Lipid_Score, Fruit_color, Plant_origin), all_vars(!is.na(.))) #make sure we have scores for all our binary variables
dat %<>%
filter(
across(
.cols = c(Plant_Form, Frugivory_score, Lipid_Score, Fruit_color, Plant_origin),
.fns = ~ !is.na(.x)
)
) #Make sure we have scores for all our binary variables
dat %<>% dplyr::filter(., Fruit_color !="") #This Remove blank fruit color entries
dat$Plant_origin[dat$Plant_origin !="native"] <- "nonnative" #condense all nonnative plants into one
#dat$real <- 1 # note that these are real interactions; important when we expand later
#dat$Frugivory_score <- paste("FrugScore", dat$Frugivory_score, sep="") #Make value names unambiguous as column names
#dat$Lipid_Score <- paste("LipScore", dat$Lipid_Score, sep="")
categories <- list(Forms=unique(dat$Plant_Form), #take the unique entries of our categorical data and save them in a list; (less typing to assign column names based on them below)
#Frugivory_score=unique(dat$Frugivory_score),
#Lipid_Score=unique(dat$Lipid_Score),
Fruit_color=unique(dat$Fruit_color),
Plant_origin=unique(dat$Plant_origin)
)
dat_old <- dat
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Plant_Form, values_from = bin)
#dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Frugivory_score, values_from = bin)
#dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Lipid_Score, values_from = bin)
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Fruit_color, values_from = bin)
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Plant_origin, values_from = bin)
dat[, which(colnames(dat)=="liana"):ncol(dat)][is.na(dat[,which(colnames(dat)=="liana"):ncol(dat)])==TRUE] <- 0 #Replae all NA's in our newly created columns with 0
dat <- left_join(dat, dat_old) #add back in our factor columns just in case we want them later
plant_litter <- PVR::PVRdecomp(phy=BIEN_subtree, type="newick", scale=TRUE)
sum((round((plant_litter@Eigen$values)/sum((plant_litter@Eigen$values)),3)*100)[1:4]) #first three vectors contain about 37.5% of variation
plant_PhyEig <-data.frame(BIEN_subtree$tip.label, plant_litter@Eigen$vectors[,1:5])
colnames(plant_PhyEig) <- c("Plant_Species", paste(colnames(plant_PhyEig)[2:ncol(plant_PhyEig)], "PlDecomp", sep=""))
plant_PhyEig$Plant_Species <- gsub(pattern="_", replace=" ", x=plant_PhyEig$Plant_Species)
dat <- left_join(dat, plant_PhyEig, by="Plant_Species")
birds <- dplyr::filter(dat, Frug_Class=="Aves")
svData <- function(dat){
mat_assym <- as.data.frame.matrix(table(dat$Frugivore_Species, dat$Plant_Species)) #Rows = Frugivores, Columns = Plants
decomp <- svd(mat_assym)#run svd decomposition
u <- decomp$u #extract first 3 axis
v <- data.frame(decomp$v) #I think this is the right dimension?
plantsSVD <-data.frame(colnames(mat_assym), v[,1], v[,2], v[,3])
colnames(plantsSVD) <- c("Plant_Species", "Psvd1", "Psvd2", "Psvd3")
frugSVD <- data.frame(colnames(t(mat_assym)), u[,1], u[,2], u[,3])
colnames(frugSVD) <- c("Frugivore_Species", "Fsvd1", "Fsvd2", "Fsvd3")
dat_wP <- left_join(dat, plantsSVD, by="Plant_Species")
dat_new <- left_join(dat_wP, frugSVD, by="Frugivore_Species")
return(dat_new)
}
birds <- svData(birds)
p_phylo <- c("c1PlDecomp", "c2PlDecomp", "c3PlDecomp", "c4PlDecomp")
p_traits <- c("fruit_diameter", "fruit_length", "tree","liana", "palm", "scrub", "yellow", "red", "black", "brown", "green", "Lipid_Score")
p_latent <- c("Psvd1", "Psvd2", "Psvd3")
f_phylo <- c("fc1", "fc2", "fc3")
f_traits <- c("Frug_Body_Mass","Frug_Mean_Gape_Size", "Frugivory_score")
f_latent <- c("Fsvd1", "Fsvd2", "Fsvd3")
View(birds)
table(is.na(Plant_F))
table(is.na(birds$Plant_Form))
table(is.na(birds$Fruit_color))
table(is.na(birds$seed_length))
table(is.na(birds$Lipid_Score))
dat <- left_join(dat, dat_old) #add back in our factor columns just in case we want them later
```
sum((round((plant_litter@Eigen$values)/sum((plant_litter@Eigen$values)),3)*100)[1:4]) #first three vectors contain about 37.5% of variation
BIEN_subtree$tip.label
tips <-BIEN_subtree$tip.label
tips
sub("_[^_]+$", "", tips)
tips <- sub("_[^_]+$", "", tips)
tips <- sub("_[^_]+$", "", tips) %>% unique()
tips <-BIEN_subtree$tip.label
tips <- sub("_[^_]+$", "", tips) %>% unique()
tips <-BIEN_subtree$tip.label
genera <- sub("_[^_]+$", "", tips) %>% unique() #Extract only genera
dat$Frugivore_Species
plant_litter <- PVR::PVRdecomp(phy=BIEN_subtree, type="newick", scale=TRUE)
sum((round((plant_litter@Eigen$values)/sum((plant_litter@Eigen$values)),3)*100)[1:4]) #first three vectors contain about 37.5% of variation
plant_PhyEig <-data.frame(BIEN_subtree$tip.label, plant_litter@Eigen$vectors[,1:5])
colnames(plant_PhyEig) <- c("Plant_Species", paste(colnames(plant_PhyEig)[2:ncol(plant_PhyEig)], "PlDecomp", sep=""))
plant_PhyEig$Plant_Species <- gsub(pattern="_", replace=" ", x=plant_PhyEig$Plant_Species)
dat <- left_join(dat, plant_PhyEig, by="Plant_Species")
birds <- dplyr::filter(dat, Frug_Class=="Aves")
View(birds)
knitr::opts_chunk$set(echo = TRUE)
install.packages("tidyverse")
install.packages("magrittr")
install.packages("igraph")
install.packages("pROC")
install.packages("BIEN")
install.packages("np")
install.packages("PVR")
install.packages("ape")
install.packages("phytools")
#install.packages("tictoc")
install.packages("corrplot")
library(tidyverse)
library(magrittr)
library(igraph)
library(pROC)
library(BIEN)
library(np)
library(PVR)
library(ape)
library("phytools")
#library(tictoc)
library(corrplot)
dat <- read.csv("Data.nosync/DataSources/ATLANTIC_frugivory.csv")
dat %<>% dplyr::filter(., Frugivore_Species != "Carollia castanea") #This bat has an incorrect gape size, so it's filtered out
dat <- dplyr::select(dat, -ID, -Latitude, -Longitude, -Study_Location, -Precision, -Study_Method, -Study.reference, -Doi.Link, -Frug_Population_Trend, -Frug_Migration_status)
dat %<>% unique(.)
load("Data.nosync/DataSources/BIEN_subtree.Rda")
Mammal_trees <- ape::read.nexus(file="Data.nosync/DataSources/VertLife_FrugMam/output.nex")
Bird_trees <- ape::read.nexus(file="Data.nosync/DataSources/VertLife_FrugBird/output.nex")
#dat <- dplyr::filter_at(dat, vars(Plant_Form, Frugivory_score, Lipid_Score, Fruit_color, Plant_origin), all_vars(!is.na(.))) #make sure we have scores for all our binary variables
dat %<>%
filter(
across(
.cols = c(Plant_Form, Frugivory_score, Lipid_Score, Fruit_color, Plant_origin),
.fns = ~ !is.na(.x)
)
) #Make sure we have scores for all our binary variables
dat %<>% dplyr::filter(., Fruit_color !="") #This Remove blank fruit color entries
dat$Plant_origin[dat$Plant_origin !="native"] <- "nonnative" #condense all nonnative plants into one
#dat$real <- 1 # note that these are real interactions; important when we expand later
#dat$Frugivory_score <- paste("FrugScore", dat$Frugivory_score, sep="") #Make value names unambiguous as column names
#dat$Lipid_Score <- paste("LipScore", dat$Lipid_Score, sep="")
categories <- list(Forms=unique(dat$Plant_Form), #take the unique entries of our categorical data and save them in a list; (less typing to assign column names based on them below)
#Frugivory_score=unique(dat$Frugivory_score),
#Lipid_Score=unique(dat$Lipid_Score),
Fruit_color=unique(dat$Fruit_color),
Plant_origin=unique(dat$Plant_origin)
)
dat_old <- dat
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Plant_Form, values_from = bin)
#dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Frugivory_score, values_from = bin)
#dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Lipid_Score, values_from = bin)
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Fruit_color, values_from = bin)
dat <- dat %>% mutate(bin=1) %>% pivot_wider(., names_from = Plant_origin, values_from = bin)
dat[, which(colnames(dat)=="liana"):ncol(dat)][is.na(dat[,which(colnames(dat)=="liana"):ncol(dat)])==TRUE] <- 0 #Replae all NA's in our newly created columns with 0
dat <- left_join(dat, dat_old) #add back in our factor columns just in case we want them later
tips <-BIEN_subtree$tip.label
genera <- sub("_[^_]+$", "", tips) %>% unique() #Extract only genera
plant_litter <- PVR::PVRdecomp(phy=BIEN_subtree, type="newick", scale=TRUE)
sum((round((plant_litter@Eigen$values)/sum((plant_litter@Eigen$values)),3)*100)[1:4]) #first three vectors contain about 37.5% of variation
plant_PhyEig <-data.frame(BIEN_subtree$tip.label, plant_litter@Eigen$vectors[,1:5])
colnames(plant_PhyEig) <- c("Plant_Species", paste(colnames(plant_PhyEig)[2:ncol(plant_PhyEig)], "PlDecomp", sep=""))
plant_PhyEig$Plant_Species <- gsub(pattern="_", replace=" ", x=plant_PhyEig$Plant_Species)
dat <- left_join(dat, plant_PhyEig, by="Plant_Species")
birds <- dplyr::filter(dat, Frug_Class=="Aves")
svData <- function(dat){
mat_assym <- as.data.frame.matrix(table(dat$Frugivore_Species, dat$Plant_Species)) #Rows = Frugivores, Columns = Plants
decomp <- svd(mat_assym)#run svd decomposition
u <- decomp$u #extract first 3 axis
v <- data.frame(decomp$v) #I think this is the right dimension?
plantsSVD <-data.frame(colnames(mat_assym), v[,1], v[,2], v[,3])
colnames(plantsSVD) <- c("Plant_Species", "Psvd1", "Psvd2", "Psvd3")
frugSVD <- data.frame(colnames(t(mat_assym)), u[,1], u[,2], u[,3])
colnames(frugSVD) <- c("Frugivore_Species", "Fsvd1", "Fsvd2", "Fsvd3")
dat_wP <- left_join(dat, plantsSVD, by="Plant_Species")
dat_new <- left_join(dat_wP, frugSVD, by="Frugivore_Species")
return(dat_new)
}
birds <- svData(birds)
install.packages("corrplot")
install.packages("phytools")
